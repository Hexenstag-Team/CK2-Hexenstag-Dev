# == normal scopes(including posttitle scopes) ==
# ROOT = receiver
# FROM = giver
# <no scope change> = attacker or receiver
# == title scopes ==
# ROOT = receiver
# FROM = giver
# <no scope change> = thirdparty landed title

# the following effects/triggers exists (example execution order: on_success->on_success_title->on_success_posttitle):
# is_valid, is_valid_title, on_add, on_add_title, on_add_posttitle, on_success, on_success_title, on_success_posttitle, on_fail, on_fail_title, on_fail_posttitle, on_reverse_demand, on_reverse_demand_title, on_reverse_demand_posttitle

# Added on_attacker_leader_death, on_defender_leader_death and on_thirdparty_death, which all trigger when corresponding character dies
# These three all have war scopes, which currently has the following scope changes:
# attacker, defender, thirdparty(only valid if thirdparty character is involved), thirdparty_title(only valid if thirdparty title is involved)
#
# ai_will_do: modifies value AI places on the CB compared to other CBs (default: 1) Note: is in title scope
# can_use_gui: If otherwise valid, the CB is listed in the Diplo View, but you can't declare war unless 'can_use_gui' is also valid (also shows a trigger tooltip.)

# max_defender_occupation_score/max_attacker_occupation_score - Defines how much war score it is possible for the defender/attacker to gain by occupying provinces. Defaults to 100. Make sure the CB has ticking warscore if using this or you could end up with never-ending wars
# max_defender_battle_score/max_attacker_battle_score - Defines how much score it is possible for the defender/attacker to gain by fighting battles. Defaults to the defines MAX_WARSCORE_FROM_BATTLE_DEFENDERS/MAX_WARSCORE_FROM_BATTLE_ATTACKERS
# hostages_block_cb	- Defaults to "yes". If set to "no", the defender having close relatives of yours imprisoned does not prevent you from declaring war
# attacker_unoccupied_warscore = yes - If attacker completely unoccupied, attacker will get ticking warscore. Only works if no title is targetted
# defender_unoccupied_warscore = yes - If defender completely unoccupied, defender will get ticking warscore. Only works if no title is targetted
# capturing_attacker_is_complete_victory - Whether capturing the attacker as a prisoner is considered automatic victory for the defender. Defaults to yes. If set to no, capture instead gives CAPTURED_HEIR_WAR_SCORE warscore
# capturing_defender_is_complete_victory - Whether capturing the defender as a prisoner is considered automatic victory for the attacker. Defaults to yes. If set to no, capture instead gives CAPTURED_HEIR_WAR_SCORE warscore

# sort_priority = 1000 # Used to override the order CBs appear in the UI. By default a CB has priority 0. Higher priority will make it appear earlier, lower later. Ties are broken by definition order, as before. It is recommended to use numbers with large gaps between them so as to make it easy to slot new CBs in between older ones
# full_hostility = yes # Use the defender's primary title rather than the 3rd party title to determine hostility to other targets. Anyone else targeting them with a CB with this flag will be hostile, as will anyone targeting the primary title
# third_party_portrait = some_scope # Optional. Will cause the scoped character to be used as the 3rd party portrait in the war overview. Scopes are the same as can_use
# diplo_view_region = some_region # Optional. Will override which provinces are highlighted on the map when the CB is selected in the diplomacy view.

shattered_world_county_conquest = {
	name = CB_NAME_SHATTERED_COUNTY_CONQUEST
	war_name = WAR_NAME_SHATTERED_COUNTY_CONQUEST
	sprite = 27
	truce_days = 1825
	hostile_against_others = yes
	full_hostility = yes
	is_permanent = yes
	check_all_titles = yes # if permanent, setting this to true will check against all of someones titles, including vassal held titles
	can_ask_to_join_war = no
	allowed_to_target_tributaries = no

	infamy_modifier = 2

	sort_priority = 795

	can_use_gui = {
		conditional_tooltip = {
			trigger = {
				has_alternate_start_setting = {
					setting = shattered_cbs
					option = on_limited
				}
			}
			NOT = {
				total_years_played = 25
			}
		}
		conditional_tooltip = {
			trigger = {
				has_alternate_start_setting = {
					setting = shattered_cbs
					option = on_long
				}
			}
			NOT = {
				total_years_played = 100
			}
		}
	}

	on_add = {
		hidden_tooltip = { fire_haruspicy_event_effect = yes }
		ROOT = {
			show_scope_change = no
			if = {
				limit = { defender = { is_offmap_governor = offmap_cathay } }
				attacker = {
					sound_effect = china_angered_emperor
					detract_grace_super_huge_effect = yes
				}
			}
		}
	}

	can_use = {
		is_shattered_world = yes
		NOT = {
			has_alternate_start_setting = {
				setting = shattered_cbs
				option = off
			}
		}
		conditional_tooltip = {
			trigger = {
				has_alternate_start_setting = {
					setting = shattered_cbs
					option = on_limited
				}
			}
			NOT = {
				total_years_played = 25
			}
		}
		conditional_tooltip = {
			trigger = {
				has_alternate_start_setting = {
					setting = shattered_cbs
					option = on_long
				}
			}
			NOT = {
				total_years_played = 100
			}
		}
		ROOT = {
			NOT = { is_liege_or_above = FROM }
			mercenary = no
		}
	}

	can_use_title = {
		tier = count
		OR = {
			FROM = {
				has_landed_title = PREV
			}
			holder_scope = {
				is_liege_or_above = FROM
				NOT = { same_realm = ROOT }
			}
		}

		NOR = {
			ROOT = {
				has_landed_title = PREV
			}
			holder_scope = {
				is_liege_or_above = ROOT
			}
		}

		location = {
			#any_neighbor_province = {
			#	owner = {
			#		OR = {
			#			character = ROOT
			#			is_liege_or_above = ROOT
			#		}
			#	}
			#}
			any_neighbor_province = {
				OR = {
					AND = {
						has_owner = yes
						owner = {
							OR = {
								character = ROOT
								is_liege_or_above = ROOT
							}
						}
					}
					AND = {
						is_land = no
						any_neighbor_province = {
							has_owner = yes
							owner = {
								OR = {
									character = ROOT
									is_liege_or_above = ROOT
								}
							}
						}
					}
				}
			}
		}
	}

	is_valid_title = {
		OR = {
			FROM = {
				has_landed_title = PREV
			}
			holder_scope = {
				is_liege_or_above = FROM
			}
		}
	}

	on_success_title = {
		if = {
			limit = {
				holder_scope = {
					tier = count
					NOT = { num_of_count_titles = 2 }
					lower_tier_than = ROOT
				}
			}

			holder_scope = {
				set_defacto_liege = ROOT
			}
		}

		if = {
			limit = {
				holder_scope = {
					OR = {
						higher_tier_than = count
						num_of_count_titles = 2
						NOT = { lower_tier_than = ROOT }
					}
				}
			}

			usurp_title_plus_barony_if_unlanded = { target = ROOT type = invasion }
			any_de_jure_vassal_title = { # take all baronies under the one we're fighting for
				limit = {
					has_holder = yes
					NOT = {
						de_facto_liege = PREV
					}
					holder_scope = {
						is_liege_or_above = FROM
					}
				}

				usurp_title_plus_barony_if_unlanded = { target = ROOT type = invasion }
			}
		}

		add_pressed_claim = FROM

		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
	}

	on_fail_title = {
		ROOT = {
			prestige = -100
		}
		FROM = {
			participation_scaled_prestige = 50
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 50 }
		}
	}

	on_reverse_demand = {
		ROOT = {
			prestige = -100
			transfer_scaled_wealth = {
				to = FROM
				value = 2.0
			}
		}
		FROM = {
			participation_scaled_prestige = 100
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}

	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}

	defender_ai_defeat_worth = {
		factor = 100
	}

	ai_will_do = {
		factor = 1
		modifier = {
			factor = 0.1
			ROOT = {
				independent = no
				same_liege = FROM
			}
		}
	}
}

#shattered_world_duchy_conquest = {
#	name = CB_NAME_SHATTERED_DUCHY_CONQUEST
#	war_name = WAR_NAME_SHATTERED_DUCHY_CONQUEST
#	sprite = 8
#	truce_days = 3650
#	is_permanent = yes
#	check_de_jure_tier = DUKE # this scans all dejure duchies for the counties which are held by or vassals(or below) of selected character. Only valid if is_permanent = yes
#	allowed_to_target_tributaries = no
#
#	infamy_modifier = 2
#
#	can_use_gui = {
#		conditional_tooltip = {
#			trigger = {
#				has_alternate_start_setting = {
#					setting = shattered_cbs
#					option = on_limited
#				}
#			}
#			NOT = {
#				total_years_played = 25
#			}
#		}
#		conditional_tooltip = {
#			trigger = {
#				has_alternate_start_setting = {
#					setting = shattered_cbs
#					option = on_long
#				}
#			}
#			NOT = {
#				total_years_played = 100
#			}
#		}
#		ROOT = {
#			show_scope_change = no
#			prestige = 500
#			NOR = {
#				higher_tier_than = DUKE
#				num_of_count_titles = 20
#			}
#		}
#	}
#
#	can_use = {
#		is_shattered_world = yes
#		NOT = {
#			has_alternate_start_setting = {
#				setting = shattered_cbs
#				option = off
#			}
#		}
#		conditional_tooltip = {
#			trigger = {
#				has_alternate_start_setting = {
#					setting = shattered_cbs
#					option = on_limited
#				}
#			}
#			NOT = {
#				total_years_played = 25
#			}
#		}
#		conditional_tooltip = {
#			trigger = {
#				has_alternate_start_setting = {
#					setting = shattered_cbs
#					option = on_long
#				}
#			}
#			NOT = {
#				total_years_played = 100
#			}
#		}
#		ROOT = {
#			NOT = { is_liege_or_above = FROM }
#			mercenary = no
#		}
#	}
#
#	can_use_title = {
#		# The attacker needs at least one county in the target kingdom, or a border, or be only two sea zones away from one of your counties
#		any_direct_de_jure_vassal_title = {
#			OR = {
#				holder_scope = {
#					OR = {
#						character = ROOT
#						is_liege_or_above = ROOT
#					}
#				}
#				location = {
#					any_neighbor_province = {
#						has_owner = yes
#						owner = {
#							OR = {
#								character = ROOT
#								is_liege_or_above = ROOT
#							}
#						}
#					}
#				}
#			}
#		}
#
#		any_de_jure_vassal_title = { # Can only liberate Duchies that are either outside of the Steppe region, or contains a Castle/City/Tribe
#			tier = COUNT
#			OR = {
#				holder_scope = {
#					character = FROM
#				}
#				holder_scope = {
#					any_liege = {
#						character = FROM
#					}
#				}
#			}
#			OR = {
#				location = {
#					NOT = {
#						region = world_steppe
#					}
#				}
#				location = {
#					any_province_holding = {
#						OR = {
#							holding_type = city
#							holding_type = castle
#							holding_type = tribal
#						}
#					}
#				}
#			}
#		}
#	}
#
#	is_valid = {
#		ROOT = {
#			NOT = { same_realm = FROM }
#			mercenary = no
#		}
#	}
#
#	on_add = {
#		ROOT = {
#			show_scope_change = no
#			prestige = -500
#		}
#		if = {
#			limit = { defender = { is_offmap_governor = offmap_cathay } }
#			attacker = {
#				sound_effect = china_angered_emperor
#				detract_grace_super_huge_effect = yes
#			}
#		}
#	}
#
#	on_success = {
#		any_attacker = {
#			limit = { NOT = { character = ROOT } }
#			hidden_tooltip = {
#				participation_scaled_prestige = 100
#			}
#		}
#
#		FROM = { prestige = -100 }
#	}
#
#	on_success_title = {
#		ROOT = {
#			vassalize_or_take_under_title = {
#				title = PREV
#				enemy = FROM
#				anti_nomad = yes
#				type = invasion
#			}
#		}
#	}
#
#	on_fail = {
#		ROOT = {
#			prestige = -200
#		}
#	}
#
#	on_reverse_demand = {
#		ROOT = {
#			transfer_scaled_wealth = {
#				to = FROM
#				value = 4.0
#			}
#			prestige = -200
#		}
#		FROM = {
#			participation_scaled_prestige = 300
#		}
#		any_defender = {
#			limit = { NOT = { character = FROM } }
#			hidden_tooltip = {
#				participation_scaled_prestige = 300
#			}
#		}
#	}
#
#	attacker_ai_victory_worth = {
#		factor = -1 # always accept
#	}
#
#	attacker_ai_defeat_worth = {
#		factor = 100
#	}
#
#	defender_ai_victory_worth = {
#		factor = -1 # always accept
#	}
#
#	defender_ai_defeat_worth = {
#		factor = 100
#	}
#
#	ai_will_do = {
#		factor = 1
#		modifier = {
#			factor = 0
#			ROOT = {
#				NOT = {
#					is_tribal = yes
#				}
#			}
#			NOT = {
#				any_direct_de_jure_vassal_title = {
#					any_direct_de_jure_vassal_title = {
#						OR = {
#							holding_type = castle
#							holding_type = city
#						}
#					}
#				}
#			}
#		}
#		modifier = {
#			factor = 0
#			ROOT = {
#				is_tribal = yes
#			}
#			NOT = {
#				any_direct_de_jure_vassal_title = {
#					any_direct_de_jure_vassal_title = {
#						OR = {
#							holding_type = castle
#							holding_type = city
#							holding_type = tribal
#						}
#					}
#				}
#			}
#		}
#	}
#}


shattered_invasion = {
	name = CB_NAME_INVASION
	war_name = WAR_NAME_INVASION
	sprite = 8
	truce_days = 3650
	hostile_against_others = yes
	is_permanent = yes
	can_ask_to_join_war = no
	check_de_jure_tier = KING # this scans all de jure kingdoms for the counties which are held by or vassals(or below) of selected character. Only valid if is_permanent = yes

	sort_priority = 1100

	can_use = {
		ROOT = {
			has_character_flag = great_conqueror
		}

		ROOT = {
			NOT = { is_liege_or_above = FROM }
			mercenary = no
		}
	}

	can_use_title = {
		# The attacker needs at least one county in the target kingdom, or a border
		any_direct_de_jure_vassal_title = {
			any_direct_de_jure_vassal_title = {
				OR = {
					holder_scope = {
						OR = {
							character = ROOT
							is_liege_or_above = ROOT
						}
					}
					location = {
						any_neighbor_province = {
							owner = {
								OR = {
									character = ROOT
									is_liege_or_above = ROOT
								}
							}
						}
					}
				}
			}
		}
	}

	is_valid = {
		always = yes
	}

	is_valid_title = {
		FROM = {
			any_realm_title = {
				de_jure_liege_or_above = PREVPREV
			}
		}
	}

	on_add = {
		hidden_tooltip = { fire_haruspicy_event_effect = yes }
		if = {
			limit = { defender = { is_offmap_governor = offmap_cathay } }
			attacker = {
				sound_effect = china_angered_emperor
				detract_grace_super_huge_effect = yes
			}
		}
	}

	on_success = {
		ROOT = {
			prestige = 200

			hidden_tooltip = {
				occupy_minors_of_occupied_settlements = FROM
				gain_all_occupied_titles = { who = FROM type = invasion }

				if = {
					limit = {
						has_nickname = no
					}
					random_list = {
						10 = { give_nickname = nick_the_great }
						10 = { give_nickname = nick_the_magnificent }
						10 = { give_nickname = nick_the_glorious }
						10 = { give_nickname = nick_the_conqueror }
					}
				}
			}
			participation_scaled_prestige = 200

			if = {
				limit = {
					uses_decadence = yes
					FROM = { NOT = { uses_decadence = yes } }
				}
				participation_scaled_decadence = -20
			}
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = {
				participation_scaled_prestige = 200
				if = {
					limit = {
						uses_decadence = yes
						FROM = { NOT = { uses_decadence = yes } }
					}
					participation_scaled_decadence = -20
				}
			}
		}
		FROM = {
			prestige = -200
		}
	}

	on_success_title = {
		custom_tooltip = {
			text = tribal_invasion_succ_tip
			hidden_tooltip = {
				ROOT = {
					vassalize_or_take_under_title_destroy_duchies = {
						title = PREV
						enemy = FROM
						is_crusade = yes # Even if the title holder is not participating in the war, gain holdings occupied by all Crusade participants
						type = invasion
					}
				}
			}
		}
	}

	on_fail = {
		FROM = {
			prestige = 100
		}
		FROM = {
			if = {
				limit = {
					has_dlc = "Legacy of Rome"
					has_landed_title = e_the_empire
					religion_group = old_world_group
				}
				hidden_tooltip = { character_event = { id = LoR.30 days = 12 } }
			}
			participation_scaled_prestige = 100
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 100 }
		}
		ROOT = {
			prestige = -200
		}
	}

	on_reverse_demand = {
		ROOT = {
			prestige = -200
			transfer_scaled_wealth = {
				to = FROM
				value = 4.0
			}
			decadence = 10
		}
		FROM = {
			prestige = 200
			if = {
				limit = {
					has_dlc = "Legacy of Rome"
					has_landed_title = e_the_empire
					religion_group = old_world_group
				}
				hidden_tooltip = { character_event = { id = LoR.30 days = 12 } }
			}
			participation_scaled_prestige = 200
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 200 }
		}
	}

	attacker_ai_victory_worth = {
		factor = 100
	}

	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}

	defender_ai_defeat_worth = {
		factor = 150
	}

	ai_will_do = {
		factor = 20
	}
}
