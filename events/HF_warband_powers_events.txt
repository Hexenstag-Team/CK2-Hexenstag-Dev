# Written by Flavio (WB.25000 - WB.25071)

namespace = WB

#############################################
## Power 2: Summon Commander
character_event = {
    id = WB.25000
    desc = EVTDESCHFA25000
	picture = GFX_evt_viking_battle_oldgods
	border = GFX_event_normal_frame_war

    is_triggered_only = yes
    
	option = {
		name = EVTOPTCHF25000
		
		trigger = {
			OR = { 
				NOT = { #...Or there are no valid vassal candidates that can be commanders.
					any_vassal = { 
						higher_real_tier_than = BARON
						NOT = { 
							primary_title = { temporary = yes } 
						}
						OR = {
							AND = {
								OR = {
									male_can_hold_minor_title_trigger = yes
									female_can_hold_minor_commander_title_trigger = yes
								}
								is_adult = yes
							}
							has_character_flag = special_marshal
						}
				
						prisoner = no
						NOT = { trait = incapable }
						NOT = { is_inaccessible_trigger = yes }
						NOT = { has_character_flag = guru }
						NOT = { has_character_modifier = refusing_to_lead }
						NOR = {
							has_job_title = job_chancellor
							has_job_title = job_marshal
							has_job_title = job_treasurer
							has_job_title = job_spymaster
							has_job_title = job_spiritual
							has_minor_title = title_commander
						}
					} 
				}
			}
			any_realm_character = {
				NOT = {
					higher_tier_than = BARON
				}
				liege = { character = ROOT }
				has_minor_title = title_commander
				NOT = {
					martial = 10
				}
			}
			OR = {
				AND = {
					tier = COUNT
					any_realm_character = {
						count = 2
						liege = { character = ROOT }
						has_minor_title = title_commander
					}
				}
				AND = {
					tier = DUKE
					any_realm_character = {
						count = 4
						liege = { character = ROOT }
						has_minor_title = title_commander
					}
				}
				AND = {
					tier = KING
					is_nomadic = no
					any_realm_character = {
						count = 6
						liege = { character = ROOT }
						has_minor_title = title_commander
					}
				}
				AND = {
					tier = EMPEROR
					is_nomadic = no
					any_realm_character = {
						count = 8
						liege = { character = ROOT }
						has_minor_title = title_commander
					}
				}
				AND = {
					tier = KING
					is_nomadic = yes
					any_realm_character = {
						count = 2
						liege = { character = ROOT }
						has_minor_title = title_commander
					}
				}
				AND = {
					tier = EMPEROR
					is_nomadic = yes
					any_realm_character = {
						count = 4
						liege = { character = ROOT }
						has_minor_title = title_commander
					}
				}
			}
		}
		
		random_realm_character = {
			limit = {
				NOT = {
					higher_tier_than = BARON
				}
				liege = { character = ROOT }
				has_minor_title = title_commander
				NOT = {
					martial = 12
				}
			}
			opinion = {
				modifier = insulted
				who = ROOT
				years = 2
			}
			remove_title = title_commander
		}
		
		event_target:invited_warband_soldier = {
			show_scope_change = no
			opinion = {
				modifier = opinion_loyal_servant
				who = ROOT
				years = 100
			}
			give_minor_title = title_commander
		}
	}
    option = {
        name = EVTOPTAHF25000
        trigger = {
			OR = { 
				NOT = { #...Or there are no valid vassal candidates that can be commanders.
					any_vassal = { 
						higher_real_tier_than = BARON
						NOT = { 
							primary_title = { temporary = yes } 
						}
						OR = {
							AND = {
								OR = {
									male_can_hold_minor_title_trigger = yes
									female_can_hold_minor_commander_title_trigger = yes
								}
								is_adult = yes
							}
							has_character_flag = special_marshal
						}
				
						prisoner = no
						NOT = { trait = incapable }
						NOT = { is_inaccessible_trigger = yes }
						NOT = { has_character_flag = guru }
						NOT = { has_character_modifier = refusing_to_lead }
						NOR = {
							has_job_title = job_chancellor
							has_job_title = job_marshal
							has_job_title = job_treasurer
							has_job_title = job_spymaster
							has_job_title = job_spiritual
							has_minor_title = title_commander
						}
					} 
				}
			}
            OR = {
                AND = {
                    tier = COUNT
                    NOT = {
                        any_realm_character = {
                            count = 2
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                    }
                }
                AND = {
                    tier = DUKE
                    NOT = {
                        any_realm_character = {
                            count = 4
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                    }
                }
                AND = {
                    tier = KING
                    is_nomadic = no
                    NOT = {
                        any_realm_character = {
                            count = 6
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                    }
                }
                AND = {
                    tier = EMPEROR
                    is_nomadic = no
                    NOT = {
                        any_realm_character = {
                            count = 8
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                    }
                }
                AND = {
                    tier = KING
                    is_nomadic = yes
                    NOT = {
                        any_realm_character = {
                            count = 2
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                    }
                }
                AND = {
                    tier = EMPEROR
                    is_nomadic = yes
                    NOT = {
                        any_realm_character = {
                            count = 4
                            liege = { character = ROOT }
                            has_minor_title = title_commander
                        }
                    }
                }
            }
        }
        
        event_target:invited_warband_soldier = {
			show_scope_change = no
            opinion = {
                modifier = opinion_loyal_servant
                who = ROOT
                years = 100
            }
            give_minor_title = title_commander
        }
    }
    option = {
        name = EVTOPTBHF25000
        event_target:invited_warband_soldier = { 
            show_scope_change = no
            opinion = {
                modifier = opinion_loyal_servant
                who = ROOT
                years = 100
            }
        }
        ai_chance = {    
            factor = 100
        }
    }
}

#Only when war ends, remove the modifier that prevents you from taking the decision again.
character_event = {
	id = WB.25002
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		OR = {
			FROM = { 
				has_character_modifier = warband_summon_warriors_cooldown 
			}
			ROOT = { 
				has_character_modifier = warband_summon_warriors_cooldown 
			}
		}
	}

	immediate = { 
		if = {
			limit = {
				FROM = {
					has_character_modifier = warband_summon_warriors_cooldown 
				}
			}
			FROM = { character_event = { id = WB.25003 days = 1 } } #One day delay to check if this was the last war.
		}
		if = {
			limit = {
				ROOT = {
					has_character_modifier = warband_summon_warriors_cooldown 
				}
			}
			ROOT = { character_event = { id = WB.25003 days = 1 } }
		}	 
	}
}

character_event = {
	id = WB.25003
	hide_window = yes
	
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				FROM = {
					has_character_modifier = warband_summon_warriors_cooldown 
					war = no #Avoid exploitation.
				}
			}
			FROM = { remove_character_modifier = warband_summon_warriors_cooldown }
		}
		if = {
			limit = {
				ROOT = {
					has_character_modifier = warband_summon_warriors_cooldown 
					war = no #Avoid exploitation.
				}
			}
			ROOT = { remove_character_modifier = warband_summon_warriors_cooldown }
		}
	}
}


####################################################################

#On_start: setup event for scarred traits visuals and variable.
character_event = {
	id = WB.25020
	hide_window = yes

	is_triggered_only = yes

	trigger = { 
		is_save_game = no
		OR = { 
			trait = scarred
			trait = scarred_mid
			trait = scarred_high
		}
	}
	immediate = {
		add_scarred_start_effect = yes
	}
}